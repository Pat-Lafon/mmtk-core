<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="A trait which implements allocation routines. Every allocator needs to implements this trait."><meta name="keywords" content="rust, rustlang, rust-lang, Allocator"><title>Allocator in mmtk::util::alloc - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="sidebar-items.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc trait"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../mmtk/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../mmtk/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"><a href="#">Allocator</a></h2><div class="sidebar-elems"><section><h3><a href="#required-methods">Required Methods</a></h3><ul class="block"><li><a href="#tymethod.alloc">alloc</a></li><li><a href="#tymethod.alloc_slow_once">alloc_slow_once</a></li><li><a href="#tymethod.does_thread_local_allocation">does_thread_local_allocation</a></li><li><a href="#tymethod.get_plan">get_plan</a></li><li><a href="#tymethod.get_space">get_space</a></li><li><a href="#tymethod.get_tls">get_tls</a></li></ul><h3><a href="#provided-methods">Provided Methods</a></h3><ul class="block"><li><a href="#method.alloc_slow">alloc_slow</a></li><li><a href="#method.alloc_slow_inline">alloc_slow_inline</a></li><li><a href="#method.alloc_slow_once_precise_stress">alloc_slow_once_precise_stress</a></li><li><a href="#method.get_thread_local_buffer_granularity">get_thread_local_buffer_granularity</a></li><li><a href="#method.on_mutator_destroy">on_mutator_destroy</a></li></ul><h3><a href="#implementations">Methods</a></h3><ul class="block"><li><a href="#method.downcast">downcast</a></li><li><a href="#method.downcast_mut">downcast_mut</a></li><li><a href="#method.downcast_rc">downcast_rc</a></li><li><a href="#method.downcast_ref">downcast_ref</a></li><li><a href="#method.is">is</a></li></ul><h3><a href="#implementors">Implementors</a></h3></section><h2><a href="index.html">In mmtk::util::alloc</a></h2></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Trait <a href="../../index.html">mmtk</a>::<wbr><a href="../index.html">util</a>::<wbr><a href="index.html">alloc</a>::<wbr><a class="trait" href="#">Allocator</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/mmtk/util/alloc/allocator.rs.html#125-368">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><div class="item-decl"><pre class="rust trait"><code>pub trait Allocator&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt;: Downcast {
    fn <a href="#tymethod.get_tls" class="fnname">get_tls</a>(&amp;self) -&gt; <a class="struct" href="../opaque_pointer/struct.VMThread.html" title="struct mmtk::util::opaque_pointer::VMThread">VMThread</a>;
<span class="item-spacer"></span>    fn <a href="#tymethod.get_space" class="fnname">get_space</a>(&amp;self) -&gt; &amp;'static dyn Space&lt;VM&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.get_plan" class="fnname">get_plan</a>(&amp;self) -&gt; &amp;'static dyn <a class="trait" href="../../plan/trait.Plan.html" title="trait mmtk::plan::Plan">Plan</a>&lt;VM = VM&gt;;
<span class="item-spacer"></span>    fn <a href="#tymethod.does_thread_local_allocation" class="fnname">does_thread_local_allocation</a>(&amp;self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.bool.html">bool</a>;
<span class="item-spacer"></span>    fn <a href="#tymethod.alloc" class="fnname">alloc</a>(&amp;mut self, size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a>;
<span class="item-spacer"></span>    fn <a href="#tymethod.alloc_slow_once" class="fnname">alloc_slow_once</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;mut self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a><br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a>;

    fn <a href="#method.get_thread_local_buffer_granularity" class="fnname">get_thread_local_buffer_granularity</a>(&amp;self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a> { ... }
<span class="item-spacer"></span>    fn <a href="#method.alloc_slow" class="fnname">alloc_slow</a>(&amp;mut self, size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a> { ... }
<span class="item-spacer"></span>    fn <a href="#method.alloc_slow_inline" class="fnname">alloc_slow_inline</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;mut self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a><br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a> { ... }
<span class="item-spacer"></span>    fn <a href="#method.alloc_slow_once_precise_stress" class="fnname">alloc_slow_once_precise_stress</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;mut self,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;need_poll: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.bool.html">bool</a><br>&nbsp;&nbsp;&nbsp;&nbsp;) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a> { ... }
<span class="item-spacer"></span>    fn <a href="#method.on_mutator_destroy" class="fnname">on_mutator_destroy</a>(&amp;mut self) { ... }
}</code></pre></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>A trait which implements allocation routines. Every allocator needs to implements this trait.</p>
</div></details><h2 id="required-methods" class="small-section-header">Required Methods<a href="#required-methods" class="anchor"></a></h2><div class="methods"><details class="rustdoc-toggle method-toggle" open><summary><section id="tymethod.get_tls" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#127">source</a><h4 class="code-header">fn <a href="#tymethod.get_tls" class="fnname">get_tls</a>(&amp;self) -&gt; <a class="struct" href="../opaque_pointer/struct.VMThread.html" title="struct mmtk::util::opaque_pointer::VMThread">VMThread</a></h4></section></summary><div class="docblock"><p>Return the <a href="../opaque_pointer/struct.VMThread.html" title="VMThread"><code>VMThread</code></a> associated with this allocator instance.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="tymethod.get_space" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#130">source</a><h4 class="code-header">fn <a href="#tymethod.get_space" class="fnname">get_space</a>(&amp;self) -&gt; &amp;'static dyn Space&lt;VM&gt;</h4></section></summary><div class="docblock"><p>Return the <a href="src/policy/space/Space"><code>Space</code></a> instance associated with this allocator instance.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="tymethod.get_plan" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#133">source</a><h4 class="code-header">fn <a href="#tymethod.get_plan" class="fnname">get_plan</a>(&amp;self) -&gt; &amp;'static dyn <a class="trait" href="../../plan/trait.Plan.html" title="trait mmtk::plan::Plan">Plan</a>&lt;VM = VM&gt;</h4></section></summary><div class="docblock"><p>Return the <a href="../../plan/trait.Plan.html" title="Plan"><code>Plan</code></a> instance that this allocator instance is associated with.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="tymethod.does_thread_local_allocation" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#137">source</a><h4 class="code-header">fn <a href="#tymethod.does_thread_local_allocation" class="fnname">does_thread_local_allocation</a>(&amp;self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.bool.html">bool</a></h4></section></summary><div class="docblock"><p>Return if this allocator can do thread local allocation. If an allocator does not do thread
local allocation, each allocation will go to slowpath and will have a check for GC polls.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="tymethod.alloc" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#165">source</a><h4 class="code-header">fn <a href="#tymethod.alloc" class="fnname">alloc</a>(&amp;mut self, size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a></h4></section></summary><div class="docblock"><p>An allocation attempt. The implementation of this function depends on the allocator used.
If an allocator supports thread local allocations, then the allocation will be serviced
from its TLAB, otherwise it will default to using the slowpath, i.e. <a href="trait.Allocator.html#method.alloc_slow"><code>alloc_slow</code></a>.</p>
<p>Note that in the case where the VM is out of memory, we invoke
<a href="../../vm/trait.Collection.html#method.out_of_memory" title="Collection::out_of_memory"><code>Collection::out_of_memory</code></a> to inform the binding and then return a null pointer back to
it. We have no assumptions on whether the VM will continue executing or abort immediately.</p>
<p>An allocator needs to make sure the object reference for the returned address is in the same
chunk as the returned address (so the side metadata and the SFT for an object reference is valid).
See <a href="util/alloc/object_ref_guard"><code>crate::util::alloc::object_ref_guard</code></a>.</p>
<p>Arguments:</p>
<ul>
<li><code>size</code>: the allocation size in bytes.</li>
<li><code>align</code>: the required alignment in bytes.</li>
<li><code>offset</code> the required offset in bytes.</li>
</ul>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="tymethod.alloc_slow_once" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#318">source</a><h4 class="code-header">fn <a href="#tymethod.alloc_slow_once" class="fnname">alloc_slow_once</a>(&amp;mut self, size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a></h4></section></summary><div class="docblock"><p>Single slow path allocation attempt. This is called by <a href="trait.Allocator.html#method.alloc_slow_inline"><code>alloc_slow_inline</code></a>. The
implementation of this function depends on the allocator used. Generally, if an allocator
supports thread local allocations, it will try to allocate more TLAB space here. If it
doesn’t, then (generally) the allocator simply allocates enough space for the current
object.</p>
<p>Arguments:</p>
<ul>
<li><code>size</code>: the allocation size in bytes.</li>
<li><code>align</code>: the required alignment in bytes.</li>
<li><code>offset</code> the required offset in bytes.</li>
</ul>
</div></details></div><h2 id="provided-methods" class="small-section-header">Provided Methods<a href="#provided-methods" class="anchor"></a></h2><div class="methods"><details class="rustdoc-toggle method-toggle" open><summary><section id="method.get_thread_local_buffer_granularity" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#144-147">source</a><h4 class="code-header">fn <a href="#method.get_thread_local_buffer_granularity" class="fnname">get_thread_local_buffer_granularity</a>(&amp;self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a></h4></section></summary><div class="docblock"><p>Return at which granularity the allocator acquires memory from the global space and use
them as thread local buffer. For example, the <a href="struct.BumpAllocator.html"><code>BumpAllocator</code></a> acquires memory at 32KB
blocks. Depending on the actual size for the current object, they always acquire memory of
N*32KB (N&gt;=1). Thus the <a href="struct.BumpAllocator.html"><code>BumpAllocator</code></a> returns 32KB for this method.  Only allocators
that do thread local allocation need to implement this method.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.alloc_slow" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#175-177">source</a><h4 class="code-header">fn <a href="#method.alloc_slow" class="fnname">alloc_slow</a>(&amp;mut self, size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>, offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a></h4></section></summary><div class="docblock"><p>Slowpath allocation attempt. This function is explicitly not inlined for performance
considerations.</p>
<p>Arguments:</p>
<ul>
<li><code>size</code>: the allocation size in bytes.</li>
<li><code>align</code>: the required alignment in bytes.</li>
<li><code>offset</code> the required offset in bytes.</li>
</ul>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.alloc_slow_inline" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#195-306">source</a><h4 class="code-header">fn <a href="#method.alloc_slow_inline" class="fnname">alloc_slow_inline</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&amp;mut self,<br>&nbsp;&nbsp;&nbsp;&nbsp;size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a><br>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a></h4></section></summary><div class="docblock"><p>Slowpath allocation attempt. This function executes the actual slowpath allocation.  A
slowpath allocation in MMTk attempts to allocate the object using the per-allocator
definition of <a href="trait.Allocator.html#tymethod.alloc_slow_once"><code>alloc_slow_once</code></a>. This function also accounts for increasing the
allocation bytes in order to support stress testing. In case precise stress testing is
being used, the <a href="trait.Allocator.html#method.alloc_slow_once_precise_stress"><code>alloc_slow_once_precise_stress</code></a> function is used instead.</p>
<p>Note that in the case where the VM is out of memory, we invoke
<a href="../../vm/trait.Collection.html#method.out_of_memory" title="Collection::out_of_memory"><code>Collection::out_of_memory</code></a> with a <a href="enum.AllocationError.html#variant.HeapOutOfMemory" title="AllocationError::HeapOutOfMemory"><code>AllocationError::HeapOutOfMemory</code></a> error to inform
the binding and then return a null pointer back to it. We have no assumptions on whether
the VM will continue executing or abort immediately on a
<a href="enum.AllocationError.html#variant.HeapOutOfMemory" title="AllocationError::HeapOutOfMemory"><code>AllocationError::HeapOutOfMemory</code></a> error.</p>
<p>Arguments:</p>
<ul>
<li><code>size</code>: the allocation size in bytes.</li>
<li><code>align</code>: the required alignment in bytes.</li>
<li><code>offset</code> the required offset in bytes.</li>
</ul>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.alloc_slow_once_precise_stress" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#348-361">source</a><h4 class="code-header">fn <a href="#method.alloc_slow_once_precise_stress" class="fnname">alloc_slow_once_precise_stress</a>(<br>&nbsp;&nbsp;&nbsp;&nbsp;&amp;mut self,<br>&nbsp;&nbsp;&nbsp;&nbsp;size: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;align: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.usize.html">usize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;offset: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.isize.html">isize</a>,<br>&nbsp;&nbsp;&nbsp;&nbsp;need_poll: <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.bool.html">bool</a><br>) -&gt; <a class="struct" href="../address/struct.Address.html" title="struct mmtk::util::address::Address">Address</a></h4></section></summary><div class="docblock"><p>Single slowpath allocation attempt for stress test. When the stress factor is set (e.g. to
N), we would expect for every N bytes allocated, we will trigger a stress GC.  However, for
allocators that do thread local allocation, they may allocate from their thread local
buffer which does not have a GC poll check, and they may even allocate with the JIT
generated allocation fastpath which is unaware of stress test GC. For both cases, we are
not able to guarantee a stress GC is triggered every N bytes. To solve this, when the
stress factor is set, we will call this method instead of the normal alloc_slow_once(). We
expect the implementation of this slow allocation will trick the fastpath so every
allocation will fail in the fastpath, jump to the slow path and eventually call this method
again for the actual allocation.</p>
<p>The actual implementation about how to trick the fastpath may vary. For example, our bump
pointer allocator will set the thread local buffer limit to the buffer size instead of the
buffer end address. In this case, every fastpath check (cursor + size &lt; limit) will fail,
and jump to this slowpath. In the slowpath, we still allocate from the thread local buffer,
and recompute the limit (remaining buffer size).</p>
<p>If an allocator does not do thread local allocation (which returns false for
does_thread_local_allocation()), it does not need to override this method. The default
implementation will simply call allow_slow_once() and it will work fine for allocators that
do not have thread local allocation.</p>
<p>Arguments:</p>
<ul>
<li><code>size</code>: the allocation size in bytes.</li>
<li><code>align</code>: the required alignment in bytes.</li>
<li><code>offset</code> the required offset in bytes.</li>
<li><code>need_poll</code>: if this is true, the implementation must poll for a GC, rather than
attempting to allocate from the local buffer.</li>
</ul>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.on_mutator_destroy" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#365-367">source</a><h4 class="code-header">fn <a href="#method.on_mutator_destroy" class="fnname">on_mutator_destroy</a>(&amp;mut self)</h4></section></summary><div class="docblock"><p>The <a href="../../plan/struct.Mutator.html" title="crate::plan::Mutator"><code>crate::plan::Mutator</code></a> that includes this allocator is going to be destroyed. Some allocators
may need to save/transfer its thread local data to the space.</p>
</div></details></div><h2 id="implementations" class="small-section-header">Implementations<a href="#implementations" class="anchor"></a></h2><div id="implementations-list"><details class="rustdoc-toggle implementors-toggle" open><summary><section id="impl-dyn%20Allocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#370">source</a><a href="#impl-dyn%20Allocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM&gt; dyn <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt;<span class="where fmt-newline">where<br>&nbsp;&nbsp;&nbsp;&nbsp;VM: <a class="trait" href="https://doc.rust-lang.org/1.66.1/core/any/trait.Any.html" title="trait core::any::Any">Any</a> + 'static,<br>&nbsp;&nbsp;&nbsp;&nbsp;VM: <a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>,</span></h3></section></summary><div class="impl-items"><details class="rustdoc-toggle method-toggle" open><summary><section id="method.is" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#370">source</a><h4 class="code-header">pub fn <a href="#method.is" class="fnname">is</a>&lt;__T:&nbsp;<a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt;&gt;(&amp;self) -&gt; <a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.bool.html">bool</a></h4></section></summary><div class="docblock"><p>Returns true if the trait object wraps an object of type <code>__T</code>.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.downcast" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#370">source</a><h4 class="code-header">pub fn <a href="#method.downcast" class="fnname">downcast</a>&lt;__T:&nbsp;<a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt;&gt;(<br>&nbsp;&nbsp;&nbsp;&nbsp;self: <a class="struct" href="https://doc.rust-lang.org/1.66.1/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;Self&gt;<br>) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.66.1/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.66.1/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;__T&gt;, <a class="struct" href="https://doc.rust-lang.org/1.66.1/alloc/boxed/struct.Box.html" title="struct alloc::boxed::Box">Box</a>&lt;Self&gt;&gt;</h4></section></summary><div class="docblock"><p>Returns a boxed object from a boxed trait object if the underlying object is of type
<code>__T</code>. Returns the original boxed trait if it isn’t.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.downcast_rc" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#370">source</a><h4 class="code-header">pub fn <a href="#method.downcast_rc" class="fnname">downcast_rc</a>&lt;__T:&nbsp;<a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt;&gt;(<br>&nbsp;&nbsp;&nbsp;&nbsp;self: <a class="struct" href="https://doc.rust-lang.org/1.66.1/alloc/rc/struct.Rc.html" title="struct alloc::rc::Rc">Rc</a>&lt;Self&gt;<br>) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.66.1/core/result/enum.Result.html" title="enum core::result::Result">Result</a>&lt;<a class="struct" href="https://doc.rust-lang.org/1.66.1/alloc/rc/struct.Rc.html" title="struct alloc::rc::Rc">Rc</a>&lt;__T&gt;, <a class="struct" href="https://doc.rust-lang.org/1.66.1/alloc/rc/struct.Rc.html" title="struct alloc::rc::Rc">Rc</a>&lt;Self&gt;&gt;</h4></section></summary><div class="docblock"><p>Returns an <code>Rc</code>-ed object from an <code>Rc</code>-ed trait object if the underlying object is of
type <code>__T</code>. Returns the original <code>Rc</code>-ed trait if it isn’t.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.downcast_ref" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#370">source</a><h4 class="code-header">pub fn <a href="#method.downcast_ref" class="fnname">downcast_ref</a>&lt;__T:&nbsp;<a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt;&gt;(&amp;self) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.66.1/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.reference.html">&amp;</a>__T&gt;</h4></section></summary><div class="docblock"><p>Returns a reference to the object within the trait object if it is of type <code>__T</code>, or
<code>None</code> if it isn’t.</p>
</div></details><details class="rustdoc-toggle method-toggle" open><summary><section id="method.downcast_mut" class="method has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/allocator.rs.html#370">source</a><h4 class="code-header">pub fn <a href="#method.downcast_mut" class="fnname">downcast_mut</a>&lt;__T:&nbsp;<a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt;&gt;(&amp;mut self) -&gt; <a class="enum" href="https://doc.rust-lang.org/1.66.1/core/option/enum.Option.html" title="enum core::option::Option">Option</a>&lt;<a class="primitive" href="https://doc.rust-lang.org/1.66.1/std/primitive.reference.html">&amp;mut </a>__T&gt;</h4></section></summary><div class="docblock"><p>Returns a mutable reference to the object within the trait object if it is of type
<code>__T</code>, or <code>None</code> if it isn’t.</p>
</div></details></div></details></div><h2 id="implementors" class="small-section-header">Implementors<a href="#implementors" class="anchor"></a></h2><div id="implementors-list"><section id="impl-Allocator%3CVM%3E-for-FreeListAllocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/free_list_allocator.rs.html#32-124">source</a><a href="#impl-Allocator%3CVM%3E-for-FreeListAllocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt; <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt; for <a class="struct" href="free_list_allocator/struct.FreeListAllocator.html" title="struct mmtk::util::alloc::free_list_allocator::FreeListAllocator">FreeListAllocator</a>&lt;VM&gt;</h3></section><section id="impl-Allocator%3CVM%3E-for-ImmixAllocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/immix_allocator.rs.html#51-169">source</a><a href="#impl-Allocator%3CVM%3E-for-ImmixAllocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt; <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt; for <a class="struct" href="immix_allocator/struct.ImmixAllocator.html" title="struct mmtk::util::alloc::immix_allocator::ImmixAllocator">ImmixAllocator</a>&lt;VM&gt;</h3></section><section id="impl-Allocator%3CVM%3E-for-BumpAllocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/bumpallocator.rs.html#47-137">source</a><a href="#impl-Allocator%3CVM%3E-for-BumpAllocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt; <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt; for <a class="struct" href="struct.BumpAllocator.html" title="struct mmtk::util::alloc::BumpAllocator">BumpAllocator</a>&lt;VM&gt;</h3></section><section id="impl-Allocator%3CVM%3E-for-LargeObjectAllocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/large_object_allocator.rs.html#19-58">source</a><a href="#impl-Allocator%3CVM%3E-for-LargeObjectAllocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt; <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt; for <a class="struct" href="struct.LargeObjectAllocator.html" title="struct mmtk::util::alloc::LargeObjectAllocator">LargeObjectAllocator</a>&lt;VM&gt;</h3></section><section id="impl-Allocator%3CVM%3E-for-MallocAllocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/malloc_allocator.rs.html#19-45">source</a><a href="#impl-Allocator%3CVM%3E-for-MallocAllocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt; <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt; for <a class="struct" href="struct.MallocAllocator.html" title="struct mmtk::util::alloc::MallocAllocator">MallocAllocator</a>&lt;VM&gt;</h3></section><section id="impl-Allocator%3CVM%3E-for-MarkCompactAllocator%3CVM%3E" class="impl has-srclink"><a class="srclink rightside" href="../../../src/mmtk/util/alloc/markcompact_allocator.rs.html#30-87">source</a><a href="#impl-Allocator%3CVM%3E-for-MarkCompactAllocator%3CVM%3E" class="anchor"></a><h3 class="code-header">impl&lt;VM:&nbsp;<a class="trait" href="../../vm/trait.VMBinding.html" title="trait mmtk::vm::VMBinding">VMBinding</a>&gt; <a class="trait" href="trait.Allocator.html" title="trait mmtk::util::alloc::Allocator">Allocator</a>&lt;VM&gt; for <a class="struct" href="struct.MarkCompactAllocator.html" title="struct mmtk::util::alloc::MarkCompactAllocator">MarkCompactAllocator</a>&lt;VM&gt;</h3></section></div><script src="../../../implementors/mmtk/util/alloc/allocator/trait.Allocator.js" async></script></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="mmtk" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.1 (90743e729 2023-01-10)" ></div></body></html>